<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>SolariumCustApp documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">SolariumCustApp documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  AuthState</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/store/authSlice.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Authentication State</p>

            </p>


        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#error" 
>
                                            error
                                        </a>
                                </li>
                                <li>
                                        <a href="#isLoading" 
>
                                            isLoading
                                        </a>
                                </li>
                                <li>
                                        <a href="#isLoggedIn" 
>
                                            isLoggedIn
                                        </a>
                                </li>
                                <li>
                                        <a href="#isSendingOtp" 
>
                                            isSendingOtp
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#lastLoginTime" 
>
                                            lastLoginTime
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#refreshToken" 
>
                                            refreshToken
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#token" 
>
                                            token
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#user" 
>
                                            user
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="error"></a>
                                        <span class="name "><b>error</b>
                                            <a href="#error">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>error:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isLoading"></a>
                                        <span class="name "><b>isLoading</b>
                                            <a href="#isLoading">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isLoading:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isLoggedIn"></a>
                                        <span class="name "><b>isLoggedIn</b>
                                            <a href="#isLoggedIn">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isLoggedIn:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="isSendingOtp"></a>
                                        <span class="name "><b>isSendingOtp</b>
                                            <a href="#isSendingOtp">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>isSendingOtp:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="lastLoginTime"></a>
                                        <span class="name "><b>lastLoginTime</b>
                                            <a href="#lastLoginTime">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>lastLoginTime:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="refreshToken"></a>
                                        <span class="name "><b>refreshToken</b>
                                            <a href="#refreshToken">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>refreshToken:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="token"></a>
                                        <span class="name "><b>token</b>
                                            <a href="#token">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>token:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="user"></a>
                                        <span class="name "><b>user</b>
                                            <a href="#user">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>user:         <code><a href="../interfaces/User.html" target="_self" >User</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../interfaces/User.html" target="_self" >User</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {createSlice, createAsyncThunk, PayloadAction} from &#x27;@reduxjs/toolkit&#x27;;
import {authApi} from &#x27;../api/endpoints/auth&#x27;;
import {SecureStorageError} from &#x27;../errors/SecureStorageError&#x27;;
import {saveJWT, clearJWT, getJWT} from &#x27;../storage/secureStorage&#x27;;
import {setStorageItem, STORAGE_KEYS} from &#x27;../utils/storageHelpers&#x27;;

/**
 * User interface
 */
export interface User {
  id: string;
  phone: string;
  name: string;
  email?: string;
  address?: string;
  state?: string;
  pinCode?: string;
  role?: string;
}

/**
 * Authentication State
 */
export interface AuthState {
  isLoggedIn: boolean;
  isLoading: boolean;
  isSendingOtp: boolean;
  token?: string;
  refreshToken?: string;
  user?: User;
  lastLoginTime?: number;
  error?: string;
}

/**
 * Initial state
 */
const initialState: AuthState &#x3D; {
  isLoggedIn: false,
  isLoading: false,
  isSendingOtp: false,
  token: undefined,
  refreshToken: undefined,
  user: undefined,
  lastLoginTime: undefined,
  error: undefined,
};

// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
// ASYNC THUNKS
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

/**
 * Send OTP Async Thunk
 */
export const sendOtpThunk &#x3D; createAsyncThunk(
  &#x27;auth/sendOtp&#x27;,
  async (phone: string, {rejectWithValue}) &#x3D;&gt; {
    try {
      // Simulate API call
      await new Promise(resolve &#x3D;&gt; setTimeout(resolve, 1500));

      // In real app, this would call your OTP API
      // const response &#x3D; await otpService.sendOtp(phone);

      // For demo, always succeed
      console.log(&#x60;[Auth] OTP sent to ${phone}&#x60;);
      return {phone};
    } catch (error: any) {
      console.error(&#x27;[Auth] Send OTP error:&#x27;, error);
      return rejectWithValue(error.message || &#x27;Failed to send OTP&#x27;);
    }
  }
);

/**
 * Login with phone and OTP using secure storage
 */
export const loginWithOtp &#x3D; createAsyncThunk(
  &#x27;auth/loginWithOtp&#x27;,
  async (
    {phone, otp}: {phone: string; otp: string},
    {dispatch, rejectWithValue}
  ) &#x3D;&gt; {
    try {
      // Simulate API call - replace with real API in later tasks
      await new Promise(resolve &#x3D;&gt; setTimeout(resolve, 1500));

      // Demo: Accept OTP 123456, reject others
      if (otp !&#x3D;&#x3D; &#x27;123456&#x27;) {
        throw new Error(&#x27;Invalid OTP. Please try again.&#x27;);
      }

      const user: User &#x3D; {
        id: &#x60;user_${Date.now()}&#x60;,
        phone,
        name: &#x27;Demo User&#x27;,
        email: &#x27;demo@solarium.com&#x27;,
      };

      const token &#x3D; &#x60;demo_token_${Date.now()}&#x60;;

      // Store in secure storage
      try {
        await saveJWT(token);
        console.log(&#x27;[Auth] JWT token saved to secure storage&#x27;);
      } catch (storageError) {
        console.error(&#x27;[Auth] Failed to save JWT token:&#x27;, storageError);

        if (storageError instanceof SecureStorageError) {
          // Dispatch logout to clear any partial state
          dispatch(logout());
          // Set user-visible error message
          dispatch({
            type: &#x27;ui/setError&#x27;,
            payload: &#x27;Unable to save login session. Please try again.&#x27;,
          });
          return rejectWithValue(&#x27;Secure storage unavailable&#x27;);
        }

        // For other errors, continue but log warning
        console.warn(
          &#x27;[Auth] Non-critical storage error during login:&#x27;,
          storageError
        );
      }

      return {token, user};
    } catch (error: any) {
      console.error(&#x27;[Auth] Login failed:&#x27;, error);
      return rejectWithValue(error.message || &#x27;Login failed&#x27;);
    }
  }
);

/**
 * Logout and clear secure storage
 */
export const logoutUser &#x3D; createAsyncThunk(
  &#x27;auth/logout&#x27;,
  async (_, {dispatch}) &#x3D;&gt; {
    try {
      // Clear secure storage
      try {
        await clearJWT();
        console.log(&#x27;[Auth] JWT cleared from secure storage&#x27;);
      } catch (storageError) {
        console.error(&#x27;[Auth] Failed to clear JWT token:&#x27;, storageError);

        if (storageError instanceof SecureStorageError) {
          // Set user-visible warning but continue with logout
          dispatch({
            type: &#x27;ui/setError&#x27;,
            payload:
              &#x27;Session may not be fully cleared. Please restart the app.&#x27;,
          });
        }

        // Continue with logout even if storage clear fails
      }

      // In real app, call logout API to invalidate token
      // await authService.logout();

      console.log(&#x27;[Auth] Logout successful&#x27;);
      return true;
    } catch (error) {
      console.error(&#x27;[Auth] Logout error:&#x27;, error);
      // Still dispatch logout even if other operations fail
      return true;
    }
  }
);

/**
 * Refresh Token Async Thunk
 */
export const refreshTokenThunk &#x3D; createAsyncThunk(
  &#x27;auth/refreshToken&#x27;,
  async (_, {getState, rejectWithValue}) &#x3D;&gt; {
    try {
      const state &#x3D; getState() as {auth: AuthState};
      const {refreshToken} &#x3D; state.auth;

      if (!refreshToken) {
        return rejectWithValue(&#x27;No refresh token available&#x27;);
      }

      // Simulate API call
      await new Promise(resolve &#x3D;&gt; setTimeout(resolve, 1000));

      // In real app, call refresh token API
      // const response &#x3D; await authService.refreshToken(refreshToken);

      const newTokens &#x3D; {
        token: &#x60;refreshed_token_${Date.now()}&#x60;,
        refreshToken: &#x60;refreshed_refresh_${Date.now()}&#x60;,
      };

      // Store new token
      await setStorageItem(STORAGE_KEYS.AUTH_TOKEN, newTokens.token);

      console.log(&#x27;[Auth] Token refreshed successfully&#x27;);
      return newTokens;
    } catch (error: any) {
      console.error(&#x27;[Auth] Token refresh error:&#x27;, error);
      return rejectWithValue(error.message || &#x27;Token refresh failed&#x27;);
    }
  }
);

/**
 * Enhanced login with RTK Query integration and secure storage
 */
export const loginWithOtpEnhanced &#x3D; createAsyncThunk(
  &#x27;auth/loginWithOtpEnhanced&#x27;,
  async (
    {phone, otp}: {phone: string; otp: string},
    {dispatch, rejectWithValue}
  ) &#x3D;&gt; {
    try {
      // Use RTK Query mutation
      const result &#x3D; await dispatch(
        authApi.endpoints.verifyOtp.initiate({phone, otp})
      ).unwrap();

      // Store token in secure storage
      if (result.token) {
        try {
          await saveJWT(result.token);
          console.log(&#x27;[Auth] JWT token saved to secure storage (enhanced)&#x27;);
        } catch (storageError) {
          console.error(
            &#x27;[Auth] Failed to save JWT token (enhanced):&#x27;,
            storageError
          );

          if (storageError instanceof SecureStorageError) {
            dispatch(logout());
            dispatch({
              type: &#x27;ui/setError&#x27;,
              payload: &#x27;Unable to save login session. Please try again.&#x27;,
            });
            return rejectWithValue(&#x27;Secure storage unavailable&#x27;);
          }
        }
      }

      return result;
    } catch (error: any) {
      return rejectWithValue(error.message || &#x27;Login failed&#x27;);
    }
  }
);

/**
 * Enhanced logout with API call and secure storage
 */
export const logoutUserEnhanced &#x3D; createAsyncThunk(
  &#x27;auth/logoutUserEnhanced&#x27;,
  async (_, {dispatch}) &#x3D;&gt; {
    try {
      // Call logout API (optional - for server-side session cleanup)
      try {
        await dispatch(authApi.endpoints.logoutUser.initiate()).unwrap();
      } catch (error) {
        // Continue with logout even if API call fails
        console.warn(
          &#x27;[Auth] Logout API call failed, continuing with local logout:&#x27;,
          error
        );
      }

      // Clear secure storage
      try {
        await clearJWT();
        console.log(&#x27;[Auth] JWT cleared from secure storage (enhanced)&#x27;);
      } catch (storageError) {
        console.error(
          &#x27;[Auth] Failed to clear JWT token (enhanced):&#x27;,
          storageError
        );

        if (storageError instanceof SecureStorageError) {
          dispatch({
            type: &#x27;ui/setError&#x27;,
            payload:
              &#x27;Session may not be fully cleared. Please restart the app.&#x27;,
          });
        }
      }

      // Reset API cache
      dispatch(authApi.util.resetApiState());

      return true;
    } catch (error) {
      console.error(&#x27;[Auth] Logout error (enhanced):&#x27;, error);
      // Still return success for local logout
      return true;
    }
  }
);

/**
 * Restore authentication state on app startup
 * Validates Redux state against secure storage JWT token
 */
export const restoreAuthState &#x3D; createAsyncThunk(
  &#x27;auth/restoreAuthState&#x27;,
  async (_, {getState, dispatch, rejectWithValue}) &#x3D;&gt; {
    try {
      console.log(&#x27;[Auth] Starting auth state restoration...&#x27;);

      const state &#x3D; getState() as {auth: AuthState};
      const {isLoggedIn, user, token: reduxToken} &#x3D; state.auth;
      console.log(&#x27;reduxToken&#x27;, reduxToken);

      // Check if JWT token exists in secure storage
      let secureToken: string | undefined;
      try {
        secureToken &#x3D; await getJWT();
        console.log(&#x27;[Auth] Secure storage check completed successfully&#x27;);
      } catch (error) {
        console.error(
          &#x27;[Auth] Failed to retrieve JWT from secure storage:&#x27;,
          error
        );

        // Log detailed error information for debugging
        if (__DEV__) {
          console.error(&#x27;[Auth] Secure storage error details:&#x27;, {
            error: error instanceof Error ? error.message : &#x27;Unknown error&#x27;,
            stack: error instanceof Error ? error.stack : undefined,
            isSecureStorageError: error instanceof SecureStorageError,
            currentAuthState: {isLoggedIn, hasUser: !!user},
          });
        }

        if (error instanceof SecureStorageError) {
          // If secure storage is inaccessible and user appears logged in, logout for safety
          if (isLoggedIn) {
            console.warn(
              &#x27;[Auth] Secure storage error - logging out for safety&#x27;
            );
            dispatch(logout());
          }
          return rejectWithValue({
            type: &#x27;SECURE_STORAGE_ERROR&#x27;,
            message: &#x27;Secure storage unavailable&#x27;,
            originalError: error.message,
          });
        }

        // For other errors, assume no token exists but continue restoration
        console.warn(
          &#x27;[Auth] Non-critical secure storage error - continuing with restoration&#x27;
        );
        secureToken &#x3D; undefined;
      }

      console.log(
        &#x27;[Auth] State check - Redux logged in:&#x27;,
        isLoggedIn,
        &#x27;Secure token exists:&#x27;,
        !!secureToken
      );

      // Case 1: Redux says logged in but no secure token - logout
      if (isLoggedIn &amp;&amp; !secureToken) {
        console.warn(
          &#x27;[Auth] Logged in state but no secure token - logging out&#x27;
        );
        dispatch(logout());
        return {
          action: &#x27;logout&#x27;,
          reason: &#x27;No secure token found&#x27;,
        };
      }

      // Case 2: Redux says logged out but secure token exists - could restore but play it safe
      if (!isLoggedIn &amp;&amp; secureToken) {
        console.warn(
          &#x27;[Auth] Secure token exists but not logged in - clearing token for consistency&#x27;
        );
        try {
          await clearJWT();
        } catch (clearError) {
          console.error(&#x27;[Auth] Failed to clear orphaned token:&#x27;, clearError);
        }
        return {
          action: &#x27;clear_orphaned_token&#x27;,
          reason: &#x27;Token exists but user not logged in&#x27;,
        };
      }

      // Case 3: Both logged in and token exists - validate consistency
      if (isLoggedIn &amp;&amp; secureToken) {
        console.log(&#x27;[Auth] Auth state is consistent - user remains logged in&#x27;);
        return {
          action: &#x27;maintain&#x27;,
          reason: &#x27;State is consistent&#x27;,
        };
      }

      // Case 4: Both logged out and no token - all good
      console.log(
        &#x27;[Auth] User is logged out and no token exists - state is consistent&#x27;
      );
      return {
        action: &#x27;maintain&#x27;,
        reason: &#x27;User is properly logged out&#x27;,
      };
    } catch (error) {
      console.error(&#x27;[Auth] Auth restoration failed:&#x27;, error);

      // Log detailed error information
      if (__DEV__) {
        console.error(&#x27;[Auth] Restoration error details:&#x27;, {
          error: error instanceof Error ? error.message : &#x27;Unknown error&#x27;,
          stack: error instanceof Error ? error.stack : undefined,
          timestamp: new Date().toISOString(),
        });
      }

      return rejectWithValue({
        type: &#x27;RESTORATION_ERROR&#x27;,
        message: &#x27;Auth restoration failed&#x27;,
        originalError: error instanceof Error ? error.message : &#x27;Unknown error&#x27;,
      });
    }
  }
);

/**
 * Enhanced login success action that saves to secure storage
 * Use this instead of the direct loginSuccess action
 */
export const loginSuccessEnhanced &#x3D; createAsyncThunk(
  &#x27;auth/loginSuccessEnhanced&#x27;,
  async (
    payload: {
      token: string;
      refreshToken?: string;
      user: User;
    },
    {dispatch, rejectWithValue}
  ) &#x3D;&gt; {
    try {
      console.log(&#x27;[Auth] Processing enhanced login success...&#x27;);

      // First save JWT to secure storage
      await saveJWT(payload.token);
      console.log(&#x27;[Auth] JWT saved to secure storage successfully&#x27;);

      // Then update Redux state
      dispatch(loginSuccess(payload));

      return payload;
    } catch (error) {
      console.error(&#x27;[Auth] Failed to save JWT during login:&#x27;, error);

      if (error instanceof SecureStorageError) {
        // If secure storage fails, still complete login but warn
        console.warn(&#x27;[Auth] Secure storage failed, completing login anyway&#x27;);
        dispatch(loginSuccess(payload));

        // Set a UI warning about storage issues
        dispatch({
          type: &#x27;ui/setError&#x27;,
          payload:
            &#x27;Login successful but session may not persist. Please restart the app if you experience issues.&#x27;,
        });

        return payload;
      }

      // For other errors, fail the login
      return rejectWithValue(&#x27;Failed to complete login process&#x27;);
    }
  }
);

// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
// SLICE
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

/**
 * Auth slice
 */
const authSlice &#x3D; createSlice({
  name: &#x27;auth&#x27;,
  initialState,
  reducers: {
    // Manual loading control
    setLoading: (state, action: PayloadAction&lt;boolean&gt;) &#x3D;&gt; {
      state.isLoading &#x3D; action.payload;
    },

    // Clear error
    clearError: state &#x3D;&gt; {
      state.error &#x3D; undefined;
    },

    // Update user profile
    updateUserProfile: (state, action: PayloadAction&lt;Partial&lt;User&gt;&gt;) &#x3D;&gt; {
      if (state.user) {
        state.user &#x3D; {...state.user, ...action.payload};
      }
    },

    // Legacy actions for compatibility (keeping them for now)
    loginRequest: state &#x3D;&gt; {
      state.isLoading &#x3D; true;
      state.error &#x3D; undefined;
    },
    loginSuccess: (
      state,
      action: PayloadAction&lt;{
        token: string;
        refreshToken?: string;
        user: User;
      }&gt;
    ) &#x3D;&gt; {
      state.isLoggedIn &#x3D; true;
      state.isLoading &#x3D; false;
      state.token &#x3D; action.payload.token;
      state.refreshToken &#x3D; action.payload.refreshToken;
      state.user &#x3D; action.payload.user;
      state.lastLoginTime &#x3D; Date.now();
      state.error &#x3D; undefined;
    },
    loginFailure: (state, action: PayloadAction&lt;string&gt;) &#x3D;&gt; {
      state.isLoggedIn &#x3D; false;
      state.isLoading &#x3D; false;
      state.token &#x3D; undefined;
      state.refreshToken &#x3D; undefined;
      state.user &#x3D; undefined;
      state.error &#x3D; action.payload;
    },
    logout: state &#x3D;&gt; {
      state.isLoggedIn &#x3D; false;
      state.isLoading &#x3D; false;
      state.token &#x3D; undefined;
      state.refreshToken &#x3D; undefined;
      state.user &#x3D; undefined;
      state.lastLoginTime &#x3D; undefined;
      state.error &#x3D; undefined;
    },
  },
  extraReducers: builder &#x3D;&gt; {
    // Send OTP
    builder
      .addCase(sendOtpThunk.pending, state &#x3D;&gt; {
        state.isSendingOtp &#x3D; true;
        state.error &#x3D; undefined;
      })
      .addCase(sendOtpThunk.fulfilled, state &#x3D;&gt; {
        state.isSendingOtp &#x3D; false;
        state.error &#x3D; undefined;
      })
      .addCase(sendOtpThunk.rejected, (state, action) &#x3D;&gt; {
        state.isSendingOtp &#x3D; false;
        state.error &#x3D; action.payload as string;
      })

      // Login
      .addCase(loginWithOtp.pending, state &#x3D;&gt; {
        state.isLoading &#x3D; true;
        state.error &#x3D; undefined;
      })
      .addCase(loginWithOtp.fulfilled, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.isLoggedIn &#x3D; true;
        state.token &#x3D; action.payload.token;
        // state.refreshToken &#x3D; action.payload.refreshToken;
        state.user &#x3D; action.payload.user;
        state.lastLoginTime &#x3D; Date.now();
        state.error &#x3D; undefined;
      })
      .addCase(loginWithOtp.rejected, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.isLoggedIn &#x3D; false;
        state.token &#x3D; undefined;
        state.refreshToken &#x3D; undefined;
        state.user &#x3D; undefined;
        state.error &#x3D; action.payload as string;
      })

      // Logout
      .addCase(logoutUser.pending, state &#x3D;&gt; {
        state.isLoading &#x3D; true;
      })
      .addCase(logoutUser.fulfilled, state &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.isLoggedIn &#x3D; false;
        state.token &#x3D; undefined;
        state.refreshToken &#x3D; undefined;
        state.user &#x3D; undefined;
        state.lastLoginTime &#x3D; undefined;
        state.error &#x3D; undefined;
      })
      .addCase(logoutUser.rejected, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.error &#x3D; action.payload as string;
      })

      // Refresh Token
      .addCase(refreshTokenThunk.pending, state &#x3D;&gt; {
        state.isLoading &#x3D; true;
      })
      .addCase(refreshTokenThunk.fulfilled, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.token &#x3D; action.payload.token;
        if (action.payload.refreshToken) {
          state.refreshToken &#x3D; action.payload.refreshToken;
        }
        state.error &#x3D; undefined;
      })
      .addCase(refreshTokenThunk.rejected, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        // If refresh fails, consider logging out
        if (action.payload &#x3D;&#x3D;&#x3D; &#x27;No refresh token available&#x27;) {
          state.isLoggedIn &#x3D; false;
          state.token &#x3D; undefined;
          state.refreshToken &#x3D; undefined;
          state.user &#x3D; undefined;
        }
        state.error &#x3D; action.payload as string;
      })
      .addCase(loginWithOtpEnhanced.pending, state &#x3D;&gt; {
        state.isLoading &#x3D; true;
        state.error &#x3D; undefined;
      })
      .addCase(loginWithOtpEnhanced.fulfilled, (state, action) &#x3D;&gt; {
        state.isLoggedIn &#x3D; true;
        state.isLoading &#x3D; false;
        state.token &#x3D; action.payload.token;
        state.refreshToken &#x3D; action.payload.refreshToken;
        state.user &#x3D; action.payload.user;
        state.lastLoginTime &#x3D; Date.now();
        state.error &#x3D; undefined;
      })
      .addCase(loginWithOtpEnhanced.rejected, (state, action) &#x3D;&gt; {
        state.isLoggedIn &#x3D; false;
        state.isLoading &#x3D; false;
        state.token &#x3D; undefined;
        state.refreshToken &#x3D; undefined;
        state.user &#x3D; undefined;
        state.error &#x3D; action.payload as string;
      })
      .addCase(logoutUserEnhanced.fulfilled, state &#x3D;&gt; {
        state.isLoggedIn &#x3D; false;
        state.isLoading &#x3D; false;
        state.token &#x3D; undefined;
        state.refreshToken &#x3D; undefined;
        state.user &#x3D; undefined;
        state.lastLoginTime &#x3D; undefined;
        state.error &#x3D; undefined;
      })

      // Restore Auth State
      .addCase(restoreAuthState.pending, state &#x3D;&gt; {
        // Don&#x27;t set loading state for restoration to avoid UI flicker
        console.log(&#x27;[Auth] Auth restoration pending: state - &#x27;, state);
        console.log(&#x27;[Auth] Auth restoration in progress...&#x27;);
      })
      .addCase(restoreAuthState.fulfilled, (state, action) &#x3D;&gt; {
        // State changes are handled by the thunk itself via dispatch
        console.log(&#x27;[Auth] Auth restoration completed:&#x27;, action.payload);
      })
      .addCase(restoreAuthState.rejected, (state, action) &#x3D;&gt; {
        console.error(&#x27;[Auth] Auth restoration failed:&#x27;, action.payload);
        // Don&#x27;t change auth state on restoration failure to be safe
      })

      // Enhanced Login Success
      .addCase(loginSuccessEnhanced.pending, state &#x3D;&gt; {
        state.isLoading &#x3D; true;
        state.error &#x3D; undefined;
      })
      .addCase(loginSuccessEnhanced.fulfilled, (state, action) &#x3D;&gt; {
        // State is already updated by the dispatched loginSuccess action
        state.isLoading &#x3D; false;
        console.log(&#x27;[Auth] Enhanced login success: action - &#x27;, action);
        console.log(&#x27;[Auth] Enhanced login success completed&#x27;);
      })
      .addCase(loginSuccessEnhanced.rejected, (state, action) &#x3D;&gt; {
        state.isLoading &#x3D; false;
        state.error &#x3D; action.payload as string;
        console.error(&#x27;[Auth] Enhanced login success failed:&#x27;, action.payload);
      });
  },
});

export const {
  setLoading,
  clearError,
  updateUserProfile,
  // Legacy actions (for compatibility)
  loginRequest,
  loginSuccess,
  loginFailure,
  logout,
} &#x3D; authSlice.actions;

export default authSlice.reducer;

// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
// SELECTORS
// &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

export const selectIsLoggedIn &#x3D; (state: {auth: AuthState}) &#x3D;&gt;
  state.auth.isLoggedIn;
export const selectIsLoading &#x3D; (state: {auth: AuthState}) &#x3D;&gt;
  state.auth.isLoading;
export const selectIsSendingOtp &#x3D; (state: {auth: AuthState}) &#x3D;&gt;
  state.auth.isSendingOtp;
export const selectUser &#x3D; (state: {auth: AuthState}) &#x3D;&gt; state.auth.user;
export const selectToken &#x3D; (state: {auth: AuthState}) &#x3D;&gt; state.auth.token;
export const selectAuthError &#x3D; (state: {auth: AuthState}) &#x3D;&gt; state.auth.error;
export const selectCurrentUser &#x3D; (state: {auth: AuthState}) &#x3D;&gt; state.auth.user;
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'AuthState.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
